# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

这是一个 **KOL 指数自动跟单系统**，用于监听 Telegram 群组中多个 KOL 的交易信号，通过 AI 解析后自动在 MT5 (MetaTrader 5) 上执行交易。系统采用分布式架构，由多个独立进程协同工作。

## 核心架构

系统由 5 个独立运行的 Python 进程组成，通过 SQLite 数据库和 HTTP Webhook 进行通信：

### 1. 监听端 (`监听TG.py`)
- **职责**: 监听 Telegram 群组消息，过滤白名单 KOL
- **输出**: 通过 HTTP POST 将消息（文本+图片）发送到决策端的 `/webhook` 接口
- **配置**: 从 `配置.json` 读取监听群组ID和KOL名单，支持热更新（每10秒刷新）
- **关键**: 使用 Telethon 库，需要 Telegram API credentials

### 2. 决策端 (`决策端.py`)
- **职责**: 接收原始消息，调用 AI 分析，计算仓位，生成交易指令
- **核心功能**:
  - 调用 `AI分析.py` 进行多模态信号识别（文本+K线图）
  - 根据账户余额和止损距离动态计算手数（"以损定仓"模式）
  - 支持品种映射（将 AI 识别的标准名称转换为 MT5 具体后缀）
  - 将单个信号拆分为多个子命令（支持多 TP 分批止盈）
- **数据流**: 写入 `shadow_signals` (父信号) 和 `command_queue` (子命令) 表
- **启动**: `python 决策端.py` (默认监听 5010 端口)

### 3. 执行端 (`执行端.py`)
- **职责**: 从数据库读取待执行命令，调用 MT5 API 下单
- **核心逻辑**:
  - 轮询 `command_queue` 表中 `status='待执行'` 的记录
  - 调用 `MT5工具.py` 执行市价单或挂单
  - 监控持仓状态，检测单子是否平仓
  - **保本逻辑**: 当同组信号中有单子止盈后，自动将剩余单子的止损移至开仓价
- **启动**: `python 执行端.py`

### 4. 统计端 (`统计端.py`)
- **职责**: 实时监控持仓变化，归档战绩，计算 KOL 胜率
- **核心功能**:
  - 极速持仓监控（每5秒）：从交易所拉取持仓，检测减仓/平仓
  - 历史审计与自动保本（每180秒或被触发）：拉取历史订单，补录数据，计算战役盈亏
  - 自动RR止盈监控：根据风险回报比(RR)自动触发分批止盈
- **数据流**: 将完成的交易写入 `settlements` 表，供仪表盘展示
- **启动**: `python 统计端.py` (默认监听 7777 端口)

### 5. 监控台 (`仪表盘.py`)
- **职责**: Streamlit Web 界面，展示实时持仓、KOL 排行榜、历史信号

## 数据库结构

SQLite 数据库 `影子订单簿.db` 包含 5 张核心表：

1. **shadow_signals**: 父信号表，记录原始 KOL 信号
2. **command_queue**: 子命令队列，存储待执行的具体下单指令
3. **active_positions**: 当前持仓表，记录所有活跃的 MT5 订单
4. **settlements**: 结算表，归档已平仓的交易记录
5. **execution_logs**: 执行日志流水账

**关键关联**: `signal_id` 字段将父信号、子命令、持仓记录关联起来，用于实现同组保本逻辑。

## 配置文件

### `配置.json` (业务配置)
- **系统全局开关**: 监听群组ID、白名单开关
- **品种映射表**: AI识别名称 → MT5后缀名称（如 `XAUUSD` → `XAUUSD+`）
- **资金管理**:
  - 当前模式: "以损定仓" 或 "固定手数"
  - 默认风险率: 3% (特殊品种如黄金可设为 5%)
  - 单笔最大/最小手数限制
- **KOL监听名单**: `{话题ID: KOL名称}` 映射

### `key.json` (敏感凭证，已加入 .gitignore)
- Telegram API credentials (api_id, api_hash, session_name)
- MT5 配置 (终端路径、账号ID)
- AI 决策 API (API地址、密钥、模型配置)
- 网络代理设置

### `提示词.txt`
- AI 大脑的 System Prompt，定义信号解析规则和输出格式

## 启动流程

**标准启动顺序**（每个进程独立运行）：
```bash
# 1. 启动决策端（必须先启动，监听端需要它的 webhook）
python 决策端.py

# 2. 启动执行端（读取命令队列并下单）
python 执行端.py

# 3. 启动监听端（开始监听 Telegram）
python 监听TG.py

# 4. (可选) 启动审计端
python 统计端.py

# 5. (可选) 启动监控台
streamlit run 仪表盘.py
```

## 关键算法

### 以损定仓计算 (`决策端.py:45-125`)
```
允许亏损金额 = 账户余额 × 风险率
止损距离 = |入场价 - 止损价|
计算手数 = 允许亏损金额 / (止损距离 × 合约大小)
```

### 保本触发逻辑 (`执行端.py:202-228`)
当检测到某个 Ticket 平仓且盈利 > 0 时：
1. 查询同 `signal_id` 的所有剩余持仓
2. 调用 MT5 API 将它们的止损修改为开仓价

### 品种映射修正 (`决策端.py:172-190`)
AI 可能识别出 `XAUUSD` 或 `XAUUSDm`，系统会查找 `配置.json` 中的映射表，转换为 MT5 实际使用的 `XAUUSD+`。

## 重要注意事项

### 硬编码风险警告
代码中存在基于开发者个人账户的硬编码参数（如资金放大系数），**使用前必须仔细检查所有配置文件**，避免因参数不匹配导致爆仓。

### MT5 连接要求
- 执行端和决策端都需要连接 MT5（决策端用于查询余额和合约规格）
- MT5 必须保持运行状态
- 确保 `key.json` 中的终端路径正确

### 数据库自动修复
`数据库工具.py` 的 `初始化数据库()` 函数包含自动补丁逻辑，会检测并修复旧版本缺失的字段（如 `error_msg`, `signal_id`, `tp_goal`）。

### 失败处理策略
执行端遇到下单失败时，会调用 `标记_命令失败()` 将状态改为 "失败"，**不会重试**，防止无限循环。

## 调试技巧

### 查看实时日志
所有模块使用 `数据库工具.带时间的日志打印()` 输出带时间戳的日志，格式为 `[HH:MM:SS] 消息内容`。

### 测试 AI 决策
```bash
python AI决策.py
```
会运行内置的单元测试，模拟解析一个复杂的挂单信号。

### 测试数据库工具
```bash
python 数据库工具.py
```
会创建测试信号并验证父子关联逻辑。

### 测试 MT5 连接
```bash
python MT5工具.py
```
会测试行情获取、账户查询、合约规格查询功能。

## 依赖库

主要依赖：
- `MetaTrader5`: MT5 Python API
- `telethon`: Telegram 客户端
- `flask`: 决策端 HTTP 服务器
- `requests`: HTTP 请求
- `streamlit`: 监控台 Web 界面
- `sqlite3`: 内置数据库

## 安全协议

- **禁止提交 `key.json`**: 已加入 `.gitignore`
- **API Key 权限**: 创建交易所 API Key 时只勾选交易权限，不要勾选提现
- **小资金测试**: 首次使用建议用小号或极小资金测试

## 信号源

当前监听 Telegram 频道: https://t.me/+gVBApT2Lb_0xZDM9

需要申请 Telegram API credentials，如遇官方申请页面卡顿，可考虑第三方渠道。
