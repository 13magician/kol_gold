# æ‰§è¡Œç«¯.py
# -*- coding: utf-8 -*-
import time
import json
import datetime
import traceback
import MetaTrader5 as mt5

# å¼•å…¥åŸºå»º
import æ•°æ®åº“å·¥å…· as db
from MT5å·¥å…· import MT5åŠ©æ‰‹
from äº¤æ˜“æ—¥å¿—ç¾åŒ–æ‰“å° import æ‰“å°å™¨

class æ‰§è¡ŒæŒ‡æŒ¥å®˜:
    def __init__(self):
        # ==========================================
        # [æ–°å¢] å¼ºåˆ¶åˆå§‹åŒ–æ•°æ®åº“
        # é˜²æ­¢ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶æŠ¥ "no such table"
        # ==========================================
        try:
            print("ğŸ› ï¸ æ­£åœ¨æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§...")
            db.åˆå§‹åŒ–æ•°æ®åº“()
        except Exception as e:
            print(f"âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: {e}")
            
        self.MT5 = MT5åŠ©æ‰‹()
        if not self.MT5.å¯åŠ¨è¿æ¥():
            print("âŒ æ— æ³•å¯åŠ¨æ‰§è¡Œç«¯ï¼Œè¯·æ£€æŸ¥ MT5 è®¾ç½®")
            exit()
        self.æ­£åœ¨è¿è¡Œ = True

    def æ ¸å¿ƒå¾ªç¯(self):
        æ‰“å°å™¨.æ‰§è¡Œ_å¯åŠ¨å®Œæˆ()

        while self.æ­£åœ¨è¿è¡Œ:
            try:
                # 1. å¤„ç†æ–°å‘½ä»¤ (å¼€ä»“/æŒ‚å•)
                self.å¤„ç†_å¾…æ‰§è¡Œå‘½ä»¤()
                
                # 2. ç›‘æ§æŒä»“ (çŠ¶æ€åŒæ­¥ + è§¦å‘ä¿æœ¬)
                self.ç›‘æ§_æŒä»“ä¸ä¿æœ¬()
                
                # ä¼‘æ¯ä¸€ä¸‹ (1ç§’)
                time.sleep(1)
                
            except KeyboardInterrupt:
                print("\nğŸ›‘ ç”¨æˆ·åœæ­¢ç¨‹åº")
                self.æ­£åœ¨è¿è¡Œ = False
            except Exception as e:
                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âŒ [æ‰§è¡Œç«¯] ä¸¥é‡é”™è¯¯: {e}")
                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(traceback.format_exc()) # [Debug] æ‰“å°å®Œæ•´å †æ ˆ
                time.sleep(5)

    # ==========================================
    # æ¨¡å— A: æ‰§è¡Œä¸‹å•
    # ==========================================
    def å¤„ç†_å¾…æ‰§è¡Œå‘½ä»¤(self):
        # 1. ä»æ•°æ®åº“è¯»å–
        try:
            å¾…åŠåˆ—è¡¨ = db.è¯»å–_å¾…æ‰§è¡Œå‘½ä»¤()
        except Exception as e:
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âš ï¸ è¯»å–å‘½ä»¤é˜Ÿåˆ—å¤±è´¥ (å¯èƒ½æ•°æ®åº“ç¹å¿™): {e}")
            return
        
        for ä»»åŠ¡ in å¾…åŠåˆ—è¡¨:
            try:
                å‘½ä»¤ID = ä»»åŠ¡['id']
                SignalID = ä»»åŠ¡['signal_id']
                KOL = ä»»åŠ¡['kol_name']
                å“ç§ = ä»»åŠ¡['symbol']
                æ–¹å‘ = ä»»åŠ¡['direction'] 
                æ‰‹æ•° = ä»»åŠ¡['volume']
                ä»·æ ¼ = ä»»åŠ¡['price']
                æ­¢æŸ = ä»»åŠ¡['sl']
                æ­¢ç›ˆ = ä»»åŠ¡['tp']

                # === [æ–°å¢] å¹³ä»“/æ¸…ä»“é€»è¾‘ (ä¼˜å…ˆå¤„ç†ï¼Œè·³è¿‡æŠ¥ä»·æ£€æŸ¥) ===
                if æ–¹å‘ == "å¹³ä»“":
                    self.æ‰§è¡Œ_æ¸…ä»“æ“ä½œ(KOL, å“ç§)
                    db.æ ‡è®°_å‘½ä»¤å·²æ‰§è¡Œ(å‘½ä»¤ID, 0)
                    continue

                # === [æ–°å¢] æ­¢ç›ˆ/ä¿æœ¬é€»è¾‘ ===
                if æ–¹å‘ == "æ­¢ç›ˆ":
                    self.æ‰§è¡Œ_æ­¢ç›ˆåç»­æ“ä½œ(KOL, å“ç§)
                    db.æ ‡è®°_å‘½ä»¤å·²æ‰§è¡Œ(å‘½ä»¤ID, 0)
                    continue

                # ===========================
                # [æ–°å¢] ä»·æ ¼ä¸æ­¢æŸé¢„æ£€æŸ¥ (é˜²æ­¢ 10015 Invalid Price)
                # ===========================
                bid, ask = self.MT5.è·å–å®æ—¶æŠ¥ä»·(å“ç§)
                
                if bid is None or ask is None:
                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âš ï¸ [æ‰§è¡Œç«¯] æ— æ³•è·å– {å“ç§} æŠ¥ä»·ï¼Œæš‚ç¼“æ‰§è¡Œ (ç­‰å¾…è¡Œæƒ…)")
                    continue

                # [æ–°å¢] æ‰“å°å½“å‰çŠ¶æ€ï¼Œä¸åšæ— å¤´è‹è‡
                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ” [ä»·æ ¼æ£€æŸ¥] {å“ç§} {æ–¹å‘} | ç›®æ ‡ä»·:{ä»·æ ¼} | ç°ä»·(Bid/Ask):{bid:.4f}/{ask:.4f} | SL:{æ­¢æŸ}")

                if bid and ask:
                    # ===========================
                    # [æ–°å¢] ç­–ç•¥å¤±æ•ˆæ£€æŸ¥ (ç°ä»·å·²è¿‡æ­¢æŸçº¿ -> æ”¾å¼ƒ)
                    # ===========================
                    if æ­¢æŸ > 0.00001:
                        if "ä¹°" in æ–¹å‘ and bid < æ­¢æŸ:
                            é”™è¯¯ä¿¡æ¯ = f"ğŸ›‘ ç­–ç•¥å¤±æ•ˆ: ç°ä»·({bid}) å·²è·Œç ´æ­¢æŸ({æ­¢æŸ})ï¼Œæ”¾å¼ƒåšå¤š"
                            æ‰“å°å™¨.æ‰§è¡Œ_ä¸‹å•å¤±è´¥(å“ç§, æ‰‹æ•°, é”™è¯¯ä¿¡æ¯)
                            db.æ ‡è®°_å‘½ä»¤å¤±è´¥(å‘½ä»¤ID, é”™è¯¯ä¿¡æ¯)
                            continue
                        elif "å–" in æ–¹å‘ and ask > æ­¢æŸ:
                            é”™è¯¯ä¿¡æ¯ = f"ğŸ›‘ ç­–ç•¥å¤±æ•ˆ: ç°ä»·({ask}) å·²æ¶¨ç ´æ­¢æŸ({æ­¢æŸ})ï¼Œæ”¾å¼ƒåšç©º"
                            æ‰“å°å™¨.æ‰§è¡Œ_ä¸‹å•å¤±è´¥(å“ç§, æ‰‹æ•°, é”™è¯¯ä¿¡æ¯)
                            db.æ ‡è®°_å‘½ä»¤å¤±è´¥(å‘½ä»¤ID, é”™è¯¯ä¿¡æ¯)
                            continue

                    # --- ä¼˜åŒ–é€»è¾‘: ç°ä»·æ›´ä¼˜ä¸”SLåˆæ³•æ—¶ï¼Œè½¬ä¸ºå¸‚ä»· ---
                    # åšå¤š: ç›®æ ‡ä»· > Ask (æƒ³ä¹°è´µçš„) ä¸” SL < Bid (æ­¢æŸåœ¨ç°ä»·ä¸‹æ–¹ï¼Œå®‰å…¨)
                    if "ä¹°" in æ–¹å‘ and ä»·æ ¼ > ask and æ­¢æŸ > 0 and æ­¢æŸ < bid:
                         db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ’¡ [ä¼˜åŒ–] ç›®æ ‡ä»·({ä»·æ ¼}) > ç°ä»·({ask}) ä¸” SLå®‰å…¨ï¼Œè½¬ä¸ºå¸‚ä»·ä¹°å…¥")
                         æ–¹å‘ = "ä¹°å…¥"
                         ä»·æ ¼ = 0.0 # å¸‚ä»·å•ä»·æ ¼è®¾ä¸º0
                    
                    # åšç©º: ç›®æ ‡ä»· < Bid (æƒ³å–ä¾¿å®œ) ä¸” SL > Ask (æ­¢æŸåœ¨ç°ä»·ä¸Šæ–¹ï¼Œå®‰å…¨)
                    elif "å–" in æ–¹å‘ and ä»·æ ¼ > 0 and ä»·æ ¼ < bid and æ­¢æŸ > 0 and æ­¢æŸ > ask:
                         db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ’¡ [ä¼˜åŒ–] ç›®æ ‡ä»·({ä»·æ ¼}) < ç°ä»·({bid}) ä¸” SLå®‰å…¨ï¼Œè½¬ä¸ºå¸‚ä»·å–å‡º")
                         æ–¹å‘ = "å–å‡º"
                         ä»·æ ¼ = 0.0

                    # ===========================
                    # [æ–°å¢] æŒ‚å•ç±»å‹è‡ªåŠ¨ä¿®æ­£ (Limit <-> Stop)
                    # ===========================
                    if ä»·æ ¼ > 0: # ä»…é’ˆå¯¹æŒ‚å•
                        # --- åšå¤šä¿®æ­£ ---
                        if "ä¹°" in æ–¹å‘:
                            # [ä¿®æ”¹] ç§»é™¤ Buy Limit -> Buy Stop çš„è‡ªåŠ¨è½¬æ¢ (æ‹’ç»çªç ´äº¤æ˜“)
                            if ä»·æ ¼ < ask: # ç›®æ ‡ä»· < ç°ä»· -> å¿…é¡»æ˜¯ Buy Limit
                                if "æ­¢æŸ" in æ–¹å‘ and "é™ä»·" not in æ–¹å‘:
                                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ’¡ [ä¿®æ­£] ç›®æ ‡ä»·({ä»·æ ¼}) < Ask({ask}) -> æŠ„åº•/å›è°ƒé€»è¾‘ (Buy Limit)")
                                    æ–¹å‘ = "ä¹°å…¥é™ä»·"
                        
                        # --- åšç©ºä¿®æ­£ ---
                        elif "å–" in æ–¹å‘:
                            # [ä¿®æ”¹] ç§»é™¤ Sell Limit -> Sell Stop çš„è‡ªåŠ¨è½¬æ¢
                            if ä»·æ ¼ > bid: # ç›®æ ‡ä»· > ç°ä»· -> å¿…é¡»æ˜¯ Sell Limit
                                if "æ­¢æŸ" in æ–¹å‘ and "é™ä»·" not in æ–¹å‘:
                                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ’¡ [ä¿®æ­£] ç›®æ ‡ä»·({ä»·æ ¼}) > Bid({bid}) -> æ‘¸é¡¶/åå¼¹é€»è¾‘ (Sell Limit)")
                                    æ–¹å‘ = "å–å‡ºé™ä»·"

                    # 1. ç¡®å®šåŸºå‡†ä»·æ ¼ (ç”¨äºåˆ¤æ–­ SL æ˜¯å¦åˆæ³•)
                    åŸºå‡†ä»· = ä»·æ ¼ # é»˜è®¤ä¸ºæŒ‚å•ä»·
                    
                    # å¦‚æœæ˜¯å¸‚ä»·å• (ä»·æ ¼ä¸º0) æˆ–è€… æ˜¾å¼å¸‚ä»·æŒ‡ä»¤
                    if ä»·æ ¼ <= 0.00001 or ("é™ä»·" not in æ–¹å‘ and "æ­¢æŸ" not in æ–¹å‘):
                        if "ä¹°" in æ–¹å‘: åŸºå‡†ä»· = ask
                        elif "å–" in æ–¹å‘: åŸºå‡†ä»· = bid
                    
                    # 2. æ£€æŸ¥æ­¢æŸé€»è¾‘
                    if æ­¢æŸ > 0.00001:
                        if "ä¹°" in æ–¹å‘: # åšå¤š: SL å¿…é¡» < ä»·æ ¼
                            if æ­¢æŸ >= åŸºå‡†ä»·:
                                é”™è¯¯ä¿¡æ¯ = f"é¢„åˆ¤æ‹¦æˆª: åšå¤šSL({æ­¢æŸ}) >= å¼€ä»“ä»·({åŸºå‡†ä»·})"
                                æ‰“å°å™¨.æ‰§è¡Œ_ä¸‹å•å¤±è´¥(å“ç§, æ‰‹æ•°, é”™è¯¯ä¿¡æ¯)
                                db.æ ‡è®°_å‘½ä»¤å¤±è´¥(å‘½ä»¤ID, é”™è¯¯ä¿¡æ¯)
                                continue
                        elif "å–" in æ–¹å‘: # åšç©º: SL å¿…é¡» > ä»·æ ¼
                            if æ­¢æŸ <= åŸºå‡†ä»·:
                                é”™è¯¯ä¿¡æ¯ = f"é¢„åˆ¤æ‹¦æˆª: åšç©ºSL({æ­¢æŸ}) <= å¼€ä»“ä»·({åŸºå‡†ä»·})"
                                æ‰“å°å™¨.æ‰§è¡Œ_ä¸‹å•å¤±è´¥(å“ç§, æ‰‹æ•°, é”™è¯¯ä¿¡æ¯)
                                db.æ ‡è®°_å‘½ä»¤å¤±è´¥(å‘½ä»¤ID, é”™è¯¯ä¿¡æ¯)
                                continue

                æ‰“å°å™¨.æ‰§è¡Œ_æ”¶åˆ°ä»»åŠ¡(KOL, å“ç§, æ–¹å‘, æ‰‹æ•°, ä»·æ ¼, æ­¢æŸ, æ­¢ç›ˆ)
                # db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ”« [æ‰§è¡Œ] æ”¶åˆ°ä»»åŠ¡: {å“ç§} {æ–¹å‘} {æ‰‹æ•°}æ‰‹ (TP:{æ­¢ç›ˆ})")

                # 2. è°ƒç”¨ MT5
                æˆåŠŸ, ç»“æœ = self.MT5.æ‰§è¡Œä¸‹å•(
                    å“ç§=å“ç§, 
                    æ–¹å‘=æ–¹å‘, 
                    æ‰‹æ•°=æ‰‹æ•°, 
                    æŒ‚å•ä»·æ ¼=ä»·æ ¼, 
                    æ­¢æŸ=æ­¢æŸ, 
                    æ­¢ç›ˆ=æ­¢ç›ˆ, 
                    å¤‡æ³¨=f"Sig_{SignalID}"
                )
                
                # 3. å¤„ç†ç»“æœ
                if æˆåŠŸ:
                    Ticket = ç»“æœ
                    # ä» MT5 è·å–è¯¦ç»†ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦ç¾åŒ–è¾“å‡ºï¼‰
                    # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ç”¨å…¥å‚
                    æ‰“å°å™¨.æ‰§è¡Œ_ä¸‹å•æˆåŠŸ(å“ç§, Ticket, æ‰‹æ•°, ä»·æ ¼, æ­¢æŸ, æ­¢ç›ˆ)

                    # A. æ ‡è®°å‘½ä»¤å®Œæˆ
                    db.æ ‡è®°_å‘½ä»¤å·²æ‰§è¡Œ(å‘½ä»¤ID, Ticket)
                    
                    # B. è®°å½•åˆ°æŒä»“è¡¨
                    é€€å‡ºæè¿° = [{"ç±»å‹": "æ­¢ç›ˆ", "ä»·æ ¼": æ­¢ç›ˆ}, {"ç±»å‹": "æ­¢æŸ", "ä»·æ ¼": æ­¢æŸ}]
                    db.å†™å…¥_æŒä»“è®°å½•(
                        ticket=Ticket,
                        signal_id=SignalID,
                        kol_name=KOL,
                        symbol=å“ç§,
                        direction=æ–¹å‘,
                        entry_price=ä»·æ ¼ if "é™ä»·" in æ–¹å‘ else 0,
                        volume=æ‰‹æ•°,
                        tp_goal=æ­¢ç›ˆ,
                        exit_conditions=é€€å‡ºæè¿°,
                        status="ç›‘æ§ä¸­"
                    )
                else:
                    # === ğŸ”¥ [ä¿®æ”¹ç‚¹] å¤±è´¥å¤„ç†é€»è¾‘ ğŸ”¥ ===
                    é”™è¯¯ä¿¡æ¯ = str(ç»“æœ)
                    æ‰“å°å™¨.æ‰§è¡Œ_ä¸‹å•å¤±è´¥(å“ç§, æ‰‹æ•°, é”™è¯¯ä¿¡æ¯)
                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âš ï¸ ä¸‹å•å¤±è´¥: {é”™è¯¯ä¿¡æ¯} -> ğŸ›‘ å·²ä¸¢å¼ƒè¯¥ä»»åŠ¡ï¼Œä¸å†é‡è¯•")
                    # è°ƒç”¨æ•°æ®åº“å·¥å…·ï¼ŒæŠŠçŠ¶æ€æ”¹æˆ 'å¤±è´¥'ï¼Œè¿™æ ·ä¸‹ä¸€è½®å¾ªç¯å°±ä¸ä¼šå†è¯»åˆ°å®ƒäº†
                    db.æ ‡è®°_å‘½ä»¤å¤±è´¥(å‘½ä»¤ID, é”™è¯¯ä¿¡æ¯)

            except Exception as inner_e:
                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âŒ [æ‰§è¡Œç«¯-å•ä»»åŠ¡å¼‚å¸¸] {inner_e}")
                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(traceback.format_exc())
                # å¦‚æœæ˜¯ä»£ç æŠ¥é”™ï¼Œä¹Ÿæ ‡è®°ä¸ºå¤±è´¥ï¼Œé˜²æ­¢å¡æ­»
                db.æ ‡è®°_å‘½ä»¤å¤±è´¥(ä»»åŠ¡['id'], f"ç¨‹åºå¼‚å¸¸: {str(inner_e)}")

    # ==========================================
    # æ¨¡å— B: çŠ¶æ€åŒæ­¥ä¸ä¿æœ¬é€»è¾‘
    # ==========================================
    def ç›‘æ§_æŒä»“ä¸ä¿æœ¬(self):
        # è·å–æ•°æ®åº“é‡Œè®¤ä¸º "æ´»ç€" çš„å•å­
        try:
            æ´»è·ƒå•åˆ—è¡¨ = db.è¯»å–_æ‰€æœ‰æ´»è·ƒæŒä»“()
        except:
            return # æ•°æ®åº“å¯èƒ½å¿™

        if not æ´»è·ƒå•åˆ—è¡¨: return

        # è·å– MT5 é‡Œçš„çœŸå®æƒ…å†µ
        # 1. çœŸå®æŒä»“ (Positions)
        çœŸå®æŒä»“ = {p.ticket: p for p in self.MT5.è·å–æ‰€æœ‰æŒä»“()}
        # 2. çœŸå®æŒ‚å• (Orders - Limit/Stop)
        çœŸå®æŒ‚å• = {o.ticket: o for o in self.MT5.è·å–æ‰€æœ‰æŒ‚å•()}

        for DBå• in æ´»è·ƒå•åˆ—è¡¨:
            Ticket = DBå•['ticket']
            SignalID = DBå•['signal_id']
            KOL = DBå•['kol_name']
            EntryPrice = DBå•['entry_price']
            
            # === æƒ…å†µ 1: å•å­åœ¨æŒä»“é‡Œ (Running) ===
            if Ticket in çœŸå®æŒä»“:
                MT5å• = çœŸå®æŒä»“[Ticket]
                # æ›´æ–°ä¸€ä¸‹çœŸå®çš„å¼€ä»“ä»·å’Œæµ®ç›ˆ (ç»™ä»ªè¡¨ç›˜çœ‹)
                # è¿™é‡Œéœ€è¦å» update æ•°æ®åº“ï¼Œä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æ¯å‡ ç§’æ›´ä¸€æ¬¡ï¼Œæˆ–è€…æš‚ä¸æ›´æ–°æµ®ç›ˆ
                # å…³é”®ï¼šå¦‚æœæœ‰å¿…è¦ï¼Œä¿®æ­£ EntryPrice (å› ä¸ºæŒ‚å•æˆäº¤åï¼Œå¼€ä»“ä»·å°±ç¡®å®šäº†)
                if abs(EntryPrice - MT5å•.price_open) > 0.00001:
                    # [Debug] å‘ç°æ•°æ®åº“è®°å½•çš„å…¥åœºä»·å’Œå®é™…ä¸åŒï¼ˆé€šå¸¸å‘ç”Ÿåœ¨æŒ‚å•æˆäº¤ç¬é—´ï¼‰
                    # db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"â„¹ï¸ [Debug] ä¿®æ­£å¼€ä»“ä»·: DB={EntryPrice} -> MT5={MT5å•.price_open}")
                    # TODO: æ›´æ–°æ•°æ®åº“é‡Œçš„ entry_price
                    pass

            # === æƒ…å†µ 2: å•å­åœ¨æŒ‚å•é‡Œ (Pending) ===
            elif Ticket in çœŸå®æŒ‚å•:
                pass # è¿˜åœ¨æŒ‚ç€ï¼Œä¸ç”¨ç®¡

            # === æƒ…å†µ 3: å•å­ä¸è§äº†ï¼(Closed / Filled / Cancelled) ===
            else:
                # è¿™æ„å‘³å•å­ç»“æŸäº†ã€‚æˆ‘ä»¬éœ€è¦æŸ¥æŸ¥å®ƒæ˜¯èµšäº†è¿˜æ˜¯èµ”äº†ã€‚
                # è¿™ä¸€æ­¥æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦æŸ¥å†å²ã€‚
                # ç®€åŒ–é€»è¾‘ï¼šç›´æ¥ä» active_positions ç§»é™¤ï¼Œå½’æ¡£åˆ° settlements
                
                # å°è¯•è·å–è¯¥å•çš„æœ€ç»ˆç›ˆäº (éœ€è¦æŸ¥ HistoryDeal)
                from_date = datetime.datetime.now() - datetime.timedelta(days=1)
                history = mt5.history_deals_get(ticket=Ticket)
                
                ç›ˆäº = 0.0
                å¹³ä»“ä»· = 0.0
                if history:
                    # é€šå¸¸æœ€åä¸€ç¬” deal æ˜¯å¹³ä»“/è¿›åœº
                    deal = history[-1]
                    ç›ˆäº = deal.profit + deal.commission + deal.swap
                    å¹³ä»“ä»· = deal.price
                else:
                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âš ï¸ [Debug] æŸ¥ä¸åˆ°å†å²è®¢å• {Ticket}ï¼Œå¯èƒ½è¢«æ‰‹åŠ¨åˆ é™¤æˆ–æœªæˆäº¤æ’¤å•")

                æ‰“å°å™¨.æ‰§è¡Œ_å•å­ç»“æŸ(KOL, Ticket, DBå•['symbol'], ç›ˆäº, DBå•['entry_price'], å¹³ä»“ä»·)
                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ [å•å­ç»“æŸ] {KOL} Ticket:{Ticket} ç›ˆäº: {ç›ˆäº:.2f}")
                
                # 1. å½’æ¡£
                db.å½’æ¡£_ç»“ç®—è®°å½•(
                    signal_id=SignalID,
                    kol_name=KOL,
                    symbol=DBå•['symbol'],
                    direction=DBå•['direction'],
                    volume=DBå•['volume'],
                    entry_price=DBå•['entry_price'], # æ•°æ®åº“é‡Œå­˜çš„
                    exit_price=å¹³ä»“ä»·,
                    profit=ç›ˆäº
                )
                
                # 2. ä»æ´»è·ƒè¡¨ç§»é™¤
                db.ç§»é™¤_æŒä»“è®°å½•(Ticket)
                
                # === ğŸ”¥ æ ¸å¿ƒï¼šè§¦å‘åŒç»„ä¿æœ¬é€»è¾‘ ğŸ”¥ ===
                # å¦‚æœè¿™æ˜¯ä¸€å¼ æ­¢ç›ˆå• (ç›ˆäº > 0)ï¼Œä¸”å®ƒæœ‰å…„å¼Ÿå§å¦¹
                if ç›ˆäº > 0:
                    self.æ‰§è¡Œ_æ¨ä¿æœ¬(KOL, DBå•['symbol'])

    def æ‰§è¡Œ_æ­¢ç›ˆåç»­æ“ä½œ(self, kol_name, symbol):
        """æ”¶åˆ°æ­¢ç›ˆä¿¡å·åçš„å¤åˆæ“ä½œï¼šæ’¤é”€æŒ‚å• + æ¨ä¿æœ¬"""
        db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ¥‚ [æ‰§è¡Œæ­¢ç›ˆ] {kol_name} {symbol} -> æ’¤é”€æŒ‚å• + æ¨ä¿æœ¬")
        self.æ‰§è¡Œ_æ’¤é”€æŒ‚å•(kol_name, symbol)
        self.æ‰§è¡Œ_æ¨ä¿æœ¬(kol_name, symbol)

    def æ‰§è¡Œ_æ’¤é”€æŒ‚å•(self, kol_name, symbol):
        """æ’¤é”€æŒ‡å®šKOLæŒ‡å®šå“ç§çš„æ‰€æœ‰æŒ‚å•"""
        try:
            æŒ‚å•åˆ—è¡¨ = db.æŸ¥è¯¢_KOLæŒ‚å•(kol_name, symbol)
            if not æŒ‚å•åˆ—è¡¨: return
            
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ§¹ [æ­¢ç›ˆæ’¤å•] æ­£åœ¨æ¸…ç† {len(æŒ‚å•åˆ—è¡¨)} ä¸ªæŒ‚å•...")
            for order in æŒ‚å•åˆ—è¡¨:
                ticket = int(order['mt5_ticket'])
                res, msg = self.MT5.æ’¤é”€æŒ‚å•(ticket)
                if res: 
                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"   âœ… æ’¤å•æˆåŠŸ Ticket:{ticket}")
                else:
                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"   âš ï¸ æ’¤å•å¤±è´¥ Ticket:{ticket} | {msg}")
        except Exception as e:
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âŒ [æ­¢ç›ˆæ’¤å•] å¼‚å¸¸: {e}")

    def æ‰§è¡Œ_æ¨ä¿æœ¬(self, kol_name, symbol):
        """
        å°†è¯¥ KOL è¯¥å“ç§çš„æ‰€æœ‰æŒä»“æ¨ä¿æœ¬
        é€»è¾‘ï¼š
        1. ç›ˆåˆ©ä¸­ -> SL = å¼€ä»“ä»·
        2. äºæŸä¸­ -> SL = ç°ä»· +/- 0.02% (å¾®æŸç¦»åœº)
        """
        try:
            æ‰€æœ‰æ´»è·ƒ = db.è¯»å–_æ‰€æœ‰æ´»è·ƒæŒä»“()
            ç›®æ ‡å•å­ = [p for p in æ‰€æœ‰æ´»è·ƒ if p['kol_name'] == kol_name and p['symbol'] == symbol]
            
            if not ç›®æ ‡å•å­: return

            # è·å–æ‰€æœ‰MT5æŒä»“ä»¥è·å¾—å‡†ç¡®çš„å¼€ä»“ä»·
            mt5_positions = {p.ticket: p for p in self.MT5.è·å–æ‰€æœ‰æŒä»“()}
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸ›¡ï¸ [ä¿æœ¬é€»è¾‘] æ­£åœ¨æ£€æŸ¥ {kol_name} {symbol} çš„ {len(ç›®æ ‡å•å­)} å¼ æŒä»“...")

            for å• in ç›®æ ‡å•å­:
                Ticket = int(å•['ticket'])
                Direction = å•['direction']
                
                # ä¼˜å…ˆä½¿ç”¨MT5çœŸå®å¼€ä»“ä»·ï¼Œå¦åˆ™ä½¿ç”¨æ•°æ®åº“è®°å½•
                if Ticket in mt5_positions:
                    EntryPrice = mt5_positions[Ticket].price_open
                else:
                    EntryPrice = float(å•['entry_price'])
                
                # è·å–ç°ä»·
                bid, ask = self.MT5.è·å–å®æ—¶æŠ¥ä»·(symbol)
                if not bid: continue
                
                æ–°æ­¢æŸ = EntryPrice
                is_losing = False
                
                # åˆ¤æ–­æ˜¯å¦äºæŸ
                if "ä¹°" in Direction: # åšå¤š
                    if bid < EntryPrice: is_losing = True
                elif "å–" in Direction: # åšç©º
                    if ask > EntryPrice: is_losing = True
                
                if is_losing:
                    # äºæŸä¸­ï¼Œè®¾ä¸ºç°ä»·å¾®æŸ (0.02%)
                    if "ä¹°" in Direction:
                        æ–°æ­¢æŸ = bid * (1 - 0.0002)
                    else:
                        æ–°æ­¢æŸ = ask * (1 + 0.0002)
                    æ–°æ­¢æŸ = round(æ–°æ­¢æŸ, 5) # ç®€å•è§„æ•´å°æ•°ä½
                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"   âš ï¸ Ticket:{Ticket} æµ®äºä¸­(Open:{EntryPrice}), SLè®¾ä¸ºç°ä»·å¾®æŸ: {æ–°æ­¢æŸ}")
                else:
                    # ç›ˆåˆ©ä¸­ï¼Œè®¾ä¸ºå¼€ä»“ä»·
                    db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"   âœ… Ticket:{Ticket} æµ®ç›ˆä¸­, SLè®¾ä¸ºå¼€ä»“ä»·: {EntryPrice}")
                    æ–°æ­¢æŸ = EntryPrice

                # æ‰§è¡Œä¿®æ”¹
                self.MT5.ä¿®æ”¹è®¢å•(Ticket, æ–°æ­¢æŸ=æ–°æ­¢æŸ)
                
        except Exception as e:
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âŒ [æ¨ä¿æœ¬] å¼‚å¸¸: {e}")
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(traceback.format_exc())

    def æ‰§è¡Œ_æ¸…ä»“æ“ä½œ(self, kol_name, symbol):
        db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"ğŸš¨ [æ‰§è¡Œç«¯] æ‰§è¡Œæ¸…ä»“: {kol_name} -> {symbol}")
        å·²å¤„ç†Tickets = set()

        # 1. å¤„ç† active_positions (åŒ…æ‹¬ Botçš„æ‰€æœ‰å• + æ‰‹åŠ¨æŒä»“)
        try:
            æ‰€æœ‰æŒä»“ = db.è¯»å–_æ‰€æœ‰æ´»è·ƒæŒä»“()
            for pos in æ‰€æœ‰æŒä»“:
                if pos['kol_name'] == kol_name:
                    if symbol == "ALL" or pos['symbol'] == symbol:
                        ticket = int(pos['ticket'])
                        å·²å¤„ç†Tickets.add(ticket)
                        
                        # å°è¯•å¹³ä»“
                        res, msg = self.MT5.æ‰§è¡Œå¹³ä»“(ticket)
                        if res:
                            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âœ… [æ¸…ä»“] å¹³ä»“æˆåŠŸ Ticket:{ticket}")
                            db.ç§»é™¤_æŒä»“è®°å½•(ticket)
                        else:
                            # å¦‚æœå¹³ä»“å¤±è´¥ï¼Œå¯èƒ½æ˜¯æŒ‚å•ï¼Œå°è¯•æ’¤å•
                            res2, msg2 = self.MT5.æ’¤é”€æŒ‚å•(ticket)
                            if res2:
                                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âœ… [æ¸…ä»“] æ’¤å•æˆåŠŸ Ticket:{ticket}")
                                db.ç§»é™¤_æŒä»“è®°å½•(ticket)
                            else:
                                db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âš ï¸ [æ¸…ä»“] æ“ä½œå¤±è´¥ Ticket:{ticket} | å¹³ä»“:{msg} | æ’¤å•:{msg2}")
        except Exception as e:
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âŒ [æ¸…ä»“-æŒä»“] å¼‚å¸¸: {e}")

        # 2. å¤„ç† command_queue ä¸­çš„æŒ‚å• (ä¸»è¦æ˜¯æ‰‹åŠ¨æŒ‚å•ï¼Œä¹ŸåŒ…å«BotæŒ‚å•)
        try:
            æŒ‚å•åˆ—è¡¨ = db.æŸ¥è¯¢_KOLæŒ‚å•(kol_name, symbol)
            for order in æŒ‚å•åˆ—è¡¨:
                ticket = int(order['mt5_ticket'])
                if ticket in å·²å¤„ç†Tickets: continue
                
                res, msg = self.MT5.æ’¤é”€æŒ‚å•(ticket)
                if res: db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âœ… [æ¸…ä»“] æ’¤å•æˆåŠŸ Ticket:{ticket}")
                else: db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âš ï¸ [æ¸…ä»“] æ’¤å•å¤±è´¥ Ticket:{ticket} | {msg}")
        except Exception as e:
            db.å¸¦æ—¶é—´çš„æ—¥å¿—æ‰“å°(f"âŒ [æ¸…ä»“-æŒ‚å•] å¼‚å¸¸: {e}")

if __name__ == "__main__":
    æŒ‡æŒ¥å®˜ = æ‰§è¡ŒæŒ‡æŒ¥å®˜()
    æŒ‡æŒ¥å®˜.æ ¸å¿ƒå¾ªç¯()