# ç»Ÿè®¡ç«¯.py - MT5äº¤æ˜“ç»Ÿè®¡æœåŠ¡
# -*- coding: utf-8 -*-

import sqlite3
import json
import datetime
import threading
import time
import traceback
from flask import Flask, jsonify

# å¼•å…¥é¡¹ç›®åŸºå»º
import æ•°æ®åº“å·¥å…· as db
from MT5å·¥å…· import MT5åŠ©æ‰‹

# ================= é…ç½®åŒºåŸŸ =================
ç›‘å¬ç«¯å£ = 5020
å®æ—¶ç›‘æ§é¢‘ç‡ = 3
å¯ç”¨è¯¦ç»†æ—¥å¿— = False  # è®¾ä¸º True æ—¶æ‰è¾“å‡ºç›‘æ§æ—¥å¿—ï¼Œé»˜è®¤å…³é—­ä»¥é¿å…åˆ·å±

# ================= å…¨å±€å¯¹è±¡ =================
app = Flask(__name__)
MT5 = None

# ================= å·¥å…·å‡½æ•° =================
def è·å–æ—¶é—´():
    return datetime.datetime.now().strftime("[%H:%M:%S]")

def æ‰“å°(æ¶ˆæ¯):
    # å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒºï¼Œç¡®ä¿èƒ½åœ¨æ§åˆ¶å°ç«‹åˆ»çœ‹åˆ°
    print(f"{è·å–æ—¶é—´()} {æ¶ˆæ¯}", flush=True)

# ================= æ ¸å¿ƒåŠŸèƒ½: å®æ—¶ç›‘æ§çº¿ç¨‹ =================
def å®æ—¶ç›‘æ§æŒä»“():
    global MT5
    æ‰“å°(f"âš¡ [ç³»ç»Ÿå¯åŠ¨] å®æ—¶ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨ (æ£€æµ‹é¢‘ç‡: {å®æ—¶ç›‘æ§é¢‘ç‡}s)")

    ä¸Šä¸€æ¬¡å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸² = ""
    æ˜¯å¦é¦–è½® = True
    å½“å‰æ—¥å¿—_ç¼“å†² = []  # ç¼“å­˜å½“å‰è½®æ¬¡çš„æ‰€æœ‰æ—¥å¿—

    def ç¼“å†²æ‰“å°(æ¶ˆæ¯):
        """å°†æ—¥å¿—æ¶ˆæ¯æ·»åŠ åˆ°ç¼“å†²åŒºï¼Œä¸è®°å½•æ—¶é—´ï¼ˆé¿å…æ¯æ¬¡æ—¶é—´éƒ½ä¸åŒï¼‰"""
        å½“å‰æ—¥å¿—_ç¼“å†².append(æ¶ˆæ¯)

    def åˆ·æ–°æ—¥å¿—ç¼“å†²(æ˜¯å¦å¼ºåˆ¶æ‰“å°=False):
        """å°†ç¼“å†²çš„æ—¥å¿—å†…å®¹è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œä¸ä¸Šä¸€æ¬¡æ¯”å¯¹ï¼Œå¦‚æœä¸åŒåˆ™æ‰“å°"""
        nonlocal ä¸Šä¸€æ¬¡å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸²
        if not å½“å‰æ—¥å¿—_ç¼“å†²:
            return

        å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸² = "\n".join(å½“å‰æ—¥å¿—_ç¼“å†²)
        å½“å‰æ—¥å¿—_ç¼“å†².clear()

        # å¦‚æœæ˜¯å¼ºåˆ¶æ‰“å°æˆ–å†…å®¹æœ‰å˜åŒ–ï¼Œåˆ™è¾“å‡ºï¼ˆä»…åœ¨å¯ç”¨è¯¦ç»†æ—¥å¿—æ—¶ï¼‰
        if å¯ç”¨è¯¦ç»†æ—¥å¿— and (æ˜¯å¦å¼ºåˆ¶æ‰“å° or å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸² != ä¸Šä¸€æ¬¡å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸²):
            # åªåœ¨è¾“å‡ºæ—¶æ·»åŠ ä¸€æ¬¡æ—¶é—´æˆ³
            print(f"{è·å–æ—¶é—´()} {å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸²}", flush=True)
            ä¸Šä¸€æ¬¡å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸² = å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸²

    while True:
        # é¦–è½®ç«‹å³æ‰§è¡Œï¼Œä¹‹åæ¯æ¬¡å¾ªç¯æœ«å°¾å†ç­‰å¾…
        if not æ˜¯å¦é¦–è½®:
            time.sleep(å®æ—¶ç›‘æ§é¢‘ç‡)
        æ˜¯å¦é¦–è½® = False
        try:
            # 1. æ£€æŸ¥è¿æ¥ï¼Œè¿™éƒ¨åˆ†æ—¥å¿—éœ€è¦ç«‹åˆ»æ˜¾ç¤ºï¼Œå› ä¸ºå®ƒå¾ˆé‡è¦
            if not MT5.å·²è¿æ¥:
                æ‰“å°("------------------------------------------------")
                æ‰“å°("âš ï¸ [è¿æ¥æ£€æŸ¥] MT5 æœªè¿æ¥ï¼Œæ­£åœ¨å°è¯•è¿æ¥...")
                if MT5.å¯åŠ¨è¿æ¥():
                    æ‰“å°("âœ… [è¿æ¥æ£€æŸ¥] MT5 è¿æ¥æˆåŠŸï¼")
                    ä¸Šä¸€æ¬¡å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸² = "" # å¼ºåˆ¶åˆ·æ–°
                else:
                    æ‰“å°("âŒ [è¿æ¥æ£€æŸ¥] MT5 è¿æ¥å¤±è´¥ï¼Œ5ç§’åé‡è¯•...")
                    time.sleep(5)
                    continue

            # --- æ•°æ®é‡‡é›†åŒº (è°ƒç”¨æ–°å¢çš„ MT5 è¾…åŠ©å‡½æ•°) ---
            çœŸå®Ticket_é›†åˆ = MT5.è·å–æŒä»“ticketé›†åˆ()
            if çœŸå®Ticket_é›†åˆ is None:
                ç¼“å†²æ‰“å°("âŒ [MT5é”™è¯¯] è·å–æŒä»“è¿”å› None (å¯èƒ½è¿æ¥æ–­å¼€)")
                MT5.æ–­å¼€è¿æ¥()
                åˆ·æ–°æ—¥å¿—ç¼“å†²(æ˜¯å¦å¼ºåˆ¶æ‰“å°=True)
                time.sleep(3)
                continue

            çœŸå®æŒä»“_åˆ—è¡¨ = MT5.è·å–æ‰€æœ‰æŒä»“()
            æŒ‚å•_ticket_é›†åˆ = MT5.è·å–æŒ‚å•ticketé›†åˆ()
            æ•°æ®åº“æŒä»“_åˆ—è¡¨ = db.è¯»å–_æ‰€æœ‰æ´»è·ƒæŒä»“()
            æ•°æ®åº“_ticket_é›†åˆ = {p['ticket'] for p in æ•°æ®åº“æŒä»“_åˆ—è¡¨}
            ç­‰å¾…ä¸­çš„ä¿¡å· = db.è·å–ç­‰å¾…ä¸­çš„ä¿¡å·()

            # --- çŠ¶æ€æ„å»ºä¸æ¯”å¯¹ ---
            å½“å‰æ•°æ® = {
                'mt5_positions': sorted(list(çœŸå®Ticket_é›†åˆ)),
                'pending_orders': sorted(list(æŒ‚å•_ticket_é›†åˆ)),
                'db_positions': sorted(list(æ•°æ®åº“_ticket_é›†åˆ)),
                'waiting_signals': sorted([s[0] for s in ç­‰å¾…ä¸­çš„ä¿¡å·])
            }
            å½“å‰æ•°æ®_å­—ç¬¦ä¸² = json.dumps(å½“å‰æ•°æ®, sort_keys=True)
            æ•°æ®æ˜¯å¦å˜åŒ– = å½“å‰æ•°æ®_å­—ç¬¦ä¸² != ä¸Šä¸€æ¬¡å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸²
            ä¸Šä¸€æ¬¡å®Œæ•´æ—¥å¿—_å­—ç¬¦ä¸² = å½“å‰æ•°æ®_å­—ç¬¦ä¸²

            # åªåœ¨æ•°æ®æœ‰å˜åŒ–æˆ–é¦–æ¬¡è¿è¡Œæ—¶ç¼“å†²è¯¦ç»†æ—¥å¿—
            if æ•°æ®æ˜¯å¦å˜åŒ–:
                ç¼“å†²æ‰“å°("------------------------------------------------")
                ç¼“å†²æ‰“å°(f"ğŸ”„ [æ•°æ®æœ‰æ›´æ–°] å¼€å§‹æ–°ä¸€è½®åŒæ­¥... (æ£€æµ‹é¢‘ç‡: {å®æ—¶ç›‘æ§é¢‘ç‡}s)")
                ç¼“å†²æ‰“å°("âœ… [è¿æ¥æ£€æŸ¥] MT5 åœ¨çº¿")
                ç¼“å†²æ‰“å°("ğŸ“¡ [MT5] æ­£åœ¨åˆ†æçœŸå®æŒä»“...")
                ç¼“å†²æ‰“å°(f"ğŸ“¥ [MT5] è·å–åˆ° {len(çœŸå®æŒä»“_åˆ—è¡¨)} æ¡çœŸå®æŒä»“")
                if len(çœŸå®æŒä»“_åˆ—è¡¨) > 0:
                    ç¼“å†²æ‰“å°(f"    ğŸ‘‰ çœŸå®å•å·: {çœŸå®Ticket_é›†åˆ}")

                ç¼“å†²æ‰“å°("ğŸ“‹ [MT5] æ­£åœ¨åŒæ­¥æŒ‚å•çŠ¶æ€...")
                if æŒ‚å•_ticket_é›†åˆ:
                    ç¼“å†²æ‰“å°(f"    ğŸ‘‰ MT5æŒ‚å•: {len(æŒ‚å•_ticket_é›†åˆ)} ä¸ª {æŒ‚å•_ticket_é›†åˆ}")
                else:
                    ç¼“å†²æ‰“å°(f"    ğŸ’¤ MT5æ— æŒ‚å•")
            else:
                çœŸå®æŒä»“_åˆ—è¡¨ = MT5.è·å–æ‰€æœ‰æŒä»“()

            # å¤„ç†å¤±æ•ˆæŒ‚å• (è°ƒç”¨æ•°æ®åº“å·¥å…·å‡½æ•°)
            try:
                for signal_id, mt5_ticket in ç­‰å¾…ä¸­çš„ä¿¡å·:
                    if mt5_ticket and mt5_ticket not in æŒ‚å•_ticket_é›†åˆ:
                        db.æ ‡è®°å¤±æ•ˆæŒ‚å•(signal_id)
                        ç¼“å†²æ‰“å°(f"    ğŸ”„ å·²æ ‡è®° {signal_id} çš„å¤±æ•ˆæŒ‚å•")
            except Exception as åŒæ­¥é”™è¯¯:
                ç¼“å†²æ‰“å°(f"    âš ï¸ æŒ‚å•åŒæ­¥å‡ºé”™: {åŒæ­¥é”™è¯¯}")

            # 3. è¯»å–æ•°æ®åº“æ•°æ®
            ç¼“å†²æ‰“å°("ğŸ’¾ [DB] æ­£åœ¨è¯»å–æ•°æ®åº“å½±å­æŒä»“...")
            ç¼“å†²æ‰“å°(f"ğŸ“¥ [DB] æ•°æ®åº“é‡Œæœ‰ {len(æ•°æ®åº“æŒä»“_åˆ—è¡¨)} æ¡æ´»è·ƒæŒä»“")

            # æ£€æµ‹æ‰‹åŠ¨ä¹°å…¥æŒä»“
            ç¼“å†²æ‰“å°("ğŸ” [æ‰‹åŠ¨æ£€æµ‹] æ­£åœ¨æ£€æµ‹æ‰‹åŠ¨ä¹°å…¥æŒä»“...")
            try:
                å·²æ‰§è¡Œ_ticketé›†åˆ = db.è·å–å·²æ‰§è¡Œçš„tickets()
                æ‰‹åŠ¨æŒä»“_ticketé›†åˆ = çœŸå®Ticket_é›†åˆ - å·²æ‰§è¡Œ_ticketé›†åˆ
                if æ‰‹åŠ¨æŒä»“_ticketé›†åˆ:
                    ç¼“å†²æ‰“å°(f"    ğŸ‘‰ æ£€æµ‹åˆ° {len(æ‰‹åŠ¨æŒä»“_ticketé›†åˆ)} ä¸ªæ‰‹åŠ¨ä¹°å…¥æŒä»“: {æ‰‹åŠ¨æŒä»“_ticketé›†åˆ}")
                    for æ‰‹åŠ¨_ticket in æ‰‹åŠ¨æŒä»“_ticketé›†åˆ:
                        æŒä»“ = MT5.æŸ¥æ‰¾æŒä»“(æ‰‹åŠ¨_ticket)
                        if æŒä»“ and æ‰‹åŠ¨_ticket not in æ•°æ®åº“_ticket_é›†åˆ:
                            æ–¹å‘ = "åšå¤š" if æŒä»“.type == 0 else "åšç©º"
                            db.å†™å…¥_æŒä»“è®°å½•(
                                ticket=æ‰‹åŠ¨_ticket,
                                signal_id=None,
                                kol_name="æ‰‹åŠ¨",
                                symbol=æŒä»“.symbol,
                                direction=æ–¹å‘,
                                entry_price=æŒä»“.price_open,
                                volume=æŒä»“.volume,
                                tp_goal=æŒä»“.tp,
                                exit_conditions={},
                                status="æŒä»“ä¸­"
                            )
                            ç¼“å†²æ‰“å°(f"    âœ… å·²è®°å½•æ‰‹åŠ¨æŒä»“ Ticket:{æ‰‹åŠ¨_ticket} {æŒä»“.symbol} {æ–¹å‘}")
                            æ•°æ®åº“_ticket_é›†åˆ.add(æ‰‹åŠ¨_ticket)
            except Exception as æ‰‹åŠ¨æŒä»“é”™è¯¯:
                ç¼“å†²æ‰“å°(f"    âš ï¸ æ‰‹åŠ¨æŒä»“æ£€æµ‹å‡ºé”™: {æ‰‹åŠ¨æŒä»“é”™è¯¯}")

            # æ£€æµ‹æ‰‹åŠ¨æŒ‚å•
            ç¼“å†²æ‰“å°("ğŸ” [æ‰‹åŠ¨æ£€æµ‹] æ­£åœ¨æ£€æµ‹æ‰‹åŠ¨æŒ‚å•...")
            try:
                å·²æ‰§è¡Œ_ticketé›†åˆ = db.è·å–å·²æ‰§è¡Œçš„tickets()
                æ‰‹åŠ¨æŒ‚å•_ticketé›†åˆ = æŒ‚å•_ticket_é›†åˆ - å·²æ‰§è¡Œ_ticketé›†åˆ
                if æ‰‹åŠ¨æŒ‚å•_ticketé›†åˆ:
                    ç¼“å†²æ‰“å°(f"    ğŸ‘‰ æ£€æµ‹åˆ° {len(æ‰‹åŠ¨æŒ‚å•_ticketé›†åˆ)} ä¸ªæ‰‹åŠ¨æŒ‚å•: {æ‰‹åŠ¨æŒ‚å•_ticketé›†åˆ}")
                    for æ‰‹åŠ¨_ticket in æ‰‹åŠ¨æŒ‚å•_ticketé›†åˆ:
                        æŒ‚å• = MT5.æŸ¥æ‰¾æŒ‚å•(æ‰‹åŠ¨_ticket)
                        if æŒ‚å• and not db.æ£€æŸ¥command_queueä¸­æ˜¯å¦å­˜åœ¨(æ‰‹åŠ¨_ticket):
                            æ–¹å‘ = MT5.æ˜ å°„æŒ‚å•ç±»å‹(æŒ‚å•.type)
                            db.æ’å…¥æ‰‹åŠ¨æŒ‚å•(
                                symbol=æŒ‚å•.symbol,
                                direction=æ–¹å‘,
                                volume=æŒ‚å•.volume_current,
                                price=æŒ‚å•.price_open,
                                sl=æŒ‚å•.sl,
                                tp=æŒ‚å•.tp,
                                mt5_ticket=æ‰‹åŠ¨_ticket
                            )
                            ç¼“å†²æ‰“å°(f"    âœ… å·²è®°å½•æ‰‹åŠ¨æŒ‚å• Ticket:{æ‰‹åŠ¨_ticket} {æŒ‚å•.symbol} {æ–¹å‘}")
            except Exception as æ‰‹åŠ¨æŒ‚å•é”™è¯¯:
                ç¼“å†²æ‰“å°(f"    âš ï¸ æ‰‹åŠ¨æŒ‚å•æ£€æµ‹å‡ºé”™: {æ‰‹åŠ¨æŒ‚å•é”™è¯¯}")

            # 4. å¯¹æ¯”ä¸æ‰§è¡Œ
            ç¼“å†²æ‰“å°(f"âš–ï¸ [åŒæ­¥] å¼€å§‹å¯¹æ¯”ä¸åŒæ­¥ (MT5: {len(çœŸå®æŒä»“_åˆ—è¡¨)} vs DB: {len(æ•°æ®åº“æŒä»“_åˆ—è¡¨)})...")

            # æ›´æ–° command_queue çš„ state çŠ¶æ€
            ç¼“å†²æ‰“å°("ğŸ”„ [çŠ¶æ€åŒæ­¥] æ­£åœ¨æ›´æ–° command_queue çš„è®¢å•çŠ¶æ€...")
            try:
                æ›´æ–°æ•° = db.æ›´æ–°command_queue_state(0, çœŸå®Ticket_é›†åˆ, æŒ‚å•_ticket_é›†åˆ)
                ç¼“å†²æ‰“å°("    âœ… è®¢å•çŠ¶æ€åŒæ­¥å®Œæˆ")
            except Exception as çŠ¶æ€æ›´æ–°é”™è¯¯:
                ç¼“å†²æ‰“å°(f"    âš ï¸ çŠ¶æ€åŒæ­¥å‡ºé”™: {çŠ¶æ€æ›´æ–°é”™è¯¯}")

            # æ›´æ–°æŒ‚å•çš„ sl/tp/price å­—æ®µ
            ç¼“å†²æ‰“å°("ğŸ”„ [æ•°æ®æ›´æ–°] æ­£åœ¨æ›´æ–°æŒ‚å•çš„æ­¢æŸ/æ­¢ç›ˆ/ä»·æ ¼æ•°æ®...")
            try:
                æ›´æ–°è®¡æ•° = 0
                for mt5_ticket in æŒ‚å•_ticket_é›†åˆ:
                    æŒ‚å• = MT5.æŸ¥æ‰¾æŒ‚å•(mt5_ticket)
                    if æŒ‚å•:
                        if db.æ›´æ–°æŒ‚å•æ•°æ®(mt5_ticket, æŒ‚å•.price_open, æŒ‚å•.sl, æŒ‚å•.tp):
                            æ›´æ–°è®¡æ•° += 1
                if æ›´æ–°è®¡æ•° > 0:
                    ç¼“å†²æ‰“å°(f"    âœ… å·²æ›´æ–° {æ›´æ–°è®¡æ•°} ä¸ªæŒ‚å•çš„æ­¢æŸ/æ­¢ç›ˆ/ä»·æ ¼æ•°æ®")
            except Exception as æŒ‚å•æ›´æ–°é”™è¯¯:
                ç¼“å†²æ‰“å°(f"    âš ï¸ æŒ‚å•æ•°æ®æ›´æ–°å‡ºé”™: {æŒ‚å•æ›´æ–°é”™è¯¯}")

            # æ¸…æ´—åƒµå°¸å•
            if len(æ•°æ®åº“æŒä»“_åˆ—è¡¨) == 0 and len(çœŸå®æŒä»“_åˆ—è¡¨) == 0:
                ç¼“å†²æ‰“å°("âœ… [åŒæ­¥] åŒè¾¹ç©ºä»“ï¼Œæ— äº‹å¯åš")
            else:
                for æŒä»“ in æ•°æ®åº“æŒä»“_åˆ—è¡¨:
                    try:
                        æ•°æ®åº“_ticket = int(æŒä»“['ticket'])
                        if æ•°æ®åº“_ticket not in çœŸå®Ticket_é›†åˆ:
                            ç¼“å†²æ‰“å°(f"ğŸ§¹ [æ¸…æ´—] å‘ç°åƒµå°¸å• Ticket:{æ•°æ®åº“_ticket} (æ•°æ®åº“æœ‰ä½†MT5æ— ) -> åˆ é™¤...")
                            db.ç§»é™¤_æŒä»“è®°å½•(æ•°æ®åº“_ticket)
                    except Exception as e:
                        ç¼“å†²æ‰“å°(f"âŒ [æ¸…æ´—å‡ºé”™] Ticket:{æŒä»“.get('ticket')} | {e}")

            # æ›´æ–°æŒä»“å®æ—¶æ•°æ®
            æ›´æ–°æˆåŠŸæ•°, æ›´æ–°å¤±è´¥æ•° = 0, 0
            if len(çœŸå®æŒä»“_åˆ—è¡¨) > 0:
                for MT5è®¢å• in çœŸå®æŒä»“_åˆ—è¡¨:
                    try:
                        ticket = int(MT5è®¢å•.ticket)
                        bid, ask = MT5.è·å–å®æ—¶æŠ¥ä»·(MT5è®¢å•.symbol)
                        current_price = bid if MT5è®¢å•.type == 0 else ask
                        if db.æ›´æ–°æŒä»“å®æ—¶æ•°æ®(ticket, MT5è®¢å•.price_open, current_price, MT5è®¢å•.profit):
                            æ›´æ–°æˆåŠŸæ•° += 1
                        else:
                            æ›´æ–°å¤±è´¥æ•° += 1
                    except Exception as æ›´æ–°é”™è¯¯:
                        ç¼“å†²æ‰“å°(f"âŒ [æ›´æ–°å¤±è´¥] Ticket:{ticket} | {æ›´æ–°é”™è¯¯}")
                        æ›´æ–°å¤±è´¥æ•° += 1
                ç¼“å†²æ‰“å°(f"âœ… [æ›´æ–°] å®Œæˆ: æˆåŠŸ {æ›´æ–°æˆåŠŸæ•°}/{len(çœŸå®æŒä»“_åˆ—è¡¨)}, å¤±è´¥ {æ›´æ–°å¤±è´¥æ•°}")

            ç¼“å†²æ‰“å°("âœ… [åŒæ­¥] æœ¬è½®åŒæ­¥ç»“æŸ")

            # åœ¨å¾ªç¯æœ«å°¾åˆ·æ–°ç¼“å†²åŒºï¼Œæ¯”å¯¹å¹¶è¾“å‡ºæ—¥å¿—
            åˆ·æ–°æ—¥å¿—ç¼“å†²(æ˜¯å¦å¼ºåˆ¶æ‰“å°=æ•°æ®æ˜¯å¦å˜åŒ–)

        except Exception as e:
            æ‰“å°(f"âŒ [è‡´å‘½é”™è¯¯] ç›‘æ§çº¿ç¨‹å´©æºƒ: {e}")
            traceback.print_exc()


# ================= Flask API =================
@app.route('/health', methods=['GET'])
def å¥åº·æ£€æŸ¥():
    return jsonify({"status": "running", "mt5": MT5.å·²è¿æ¥}), 200

@app.route('/stats/summary', methods=['GET'])
def è·å–ç»Ÿè®¡æ‘˜è¦():
    try:
        with db.æ•°æ®åº“_çº¿ç¨‹é”:
            conn = db.è·å–è¿æ¥()
            cursor = conn.cursor()
            cursor.execute("SELECT SUM(profit), COUNT(*), SUM(CASE WHEN profit > 0 THEN 1 ELSE 0 END) FROM settlements")
            ç»“ç®—ç»“æœ = cursor.fetchone()
            cursor.execute("SELECT COUNT(*), SUM(unrealized_pnl) FROM active_positions")
            æ´»è·ƒç»“æœ = cursor.fetchone()
            conn.close()
        return jsonify({
            "æ€»ç›ˆäº": round(ç»“ç®—ç»“æœ[0] or 0, 2),
            "æ€»äº¤æ˜“æ•°": ç»“ç®—ç»“æœ[1] or 0,
            "èƒœå•æ•°": ç»“ç®—ç»“æœ[2] or 0,
            "å½“å‰æŒä»“æ•°": æ´»è·ƒç»“æœ[0] or 0,
            "æµ®åŠ¨ç›ˆäº": round(æ´»è·ƒç»“æœ[1] or 0, 2)
        })
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/stats/positions', methods=['GET'])
def è·å–æŒä»“():
    return jsonify({"positions": db.è¯»å–_æ‰€æœ‰æ´»è·ƒæŒä»“()}), 200

@app.route('/stats/kol', methods=['GET'])
def è·å–KOLç»Ÿè®¡():
    return jsonify({"kol_stats": db.æŸ¥è¯¢_KOLæˆ˜ç»©()}), 200

@app.route('/stats/history', methods=['GET'])
def è·å–å†å²():
    try:
        å†å²è®°å½• = []
        with db.æ•°æ®åº“_çº¿ç¨‹é”:
            conn = db.è·å–è¿æ¥()
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM settlements ORDER BY close_time DESC LIMIT 50")
            è¡Œæ•°æ® = cursor.fetchall()
            for r in è¡Œæ•°æ®: å†å²è®°å½•.append(dict(r))
            conn.close()
        return jsonify({"history": å†å²è®°å½•}), 200
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# ================= ä¸»ç¨‹åºå…¥å£ =================
if __name__ == '__main__':
    # è®¾ç½®æ§åˆ¶å°ç¼–ç ä¸ºUTF-8
    import sys
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

    print(f"\n{'='*50}")
    print(f"MT5äº¤æ˜“ç»Ÿè®¡æœåŠ¡ - æ¨¡å—åŒ–ç‰ˆæœ¬")
    print(f"   ç«¯å£: {ç›‘å¬ç«¯å£}")
    print(f"{'='*50}\n")

    db.åˆå§‹åŒ–æ•°æ®åº“()

    MT5 = MT5åŠ©æ‰‹()
    MT5.å¯åŠ¨è¿æ¥()

    t = threading.Thread(target=å®æ—¶ç›‘æ§æŒä»“, daemon=True)
    t.start()

    app.run(host='0.0.0.0', port=ç›‘å¬ç«¯å£, debug=False, threaded=True)
