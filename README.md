# 📈 KOL 指数自动跟单系统 (黄金外汇版)

> **"不生产信号，只是信号的搬运工。"**

## 📖 项目简介 (Introduction)

本项目是一个 **黄金外汇自动跟单系统**，用于监听 Telegram 群组中多个 KOL 的交易信号，通过 AI 解析后自动在 MT5 (MetaTrader 5) 上执行交易。

系统采用分布式架构，由 5 个独立进程协同工作，通过 SQLite 数据库和 HTTP Webhook 进行通信。

### 核心机制
* **信号搬运工**：全自动监听 Telegram 群组，过滤白名单 KOL，提取交易信号。
* **AI 智能决策**：调用 LLM 进行多模态分析（文本+K线图），识别交易意图。
* **自动下单执行**：根据账户余额和止损距离动态计算手数，自动在 MT5 下单。
* **实时风控监控**：持续监控持仓变化，自动触发保本逻辑，计算战绩。
* **可视化仪表盘**：Streamlit Web 界面展示实时持仓、KOL 排行榜、历史信号。

---

## 🏗️ 系统架构 (System Architecture)

本系统由 5 个独立运行的 Python 进程组成，各司其职，协同工作：

### 1. 👂 监听端 (`监听TG.py`)
* **职责**: 系统的"耳朵"。监听 Telegram 群组消息，过滤白名单 KOL。
* **核心功能**:
    * 使用 Telethon 库连接 Telegram
    * 从 `配置.json` 读取监听群组ID和KOL名单
    * 支持热更新（每10秒刷新配置）
    * 提取消息文本和图片，通过 HTTP POST 发送到决策端的 `/webhook` 接口
* **输出**: 原始消息（文本+图片）

### 2. 🧠 决策端 (`决策端.py`)
* **职责**: 系统的"大脑"。接收原始消息，调用 AI 分析，计算仓位，生成交易指令。
* **核心功能**:
    * 启动 Flask HTTP 服务器（默认监听 5010 端口）
    * 调用 `AI分析.py` 进行多模态信号识别（文本+K线图）
    * 根据账户余额和止损距离动态计算手数（"以损定仓"模式）
    * 支持品种映射（将 AI 识别的标准名称转换为 MT5 具体后缀）
    * 将单个信号拆分为多个子命令（支持多 TP 分批止盈）
* **数据流**: 写入 `shadow_signals` (父信号) 和 `command_queue` (子命令) 表
* **启动**: `python 决策端.py`

### 3. ⚔️ 执行端 (`执行端.py`)
* **职责**: 系统的"双手"。从数据库读取待执行命令，调用 MT5 API 下单。
* **核心逻辑**:
    * 轮询 `command_queue` 表中 `status='待执行'` 的记录
    * 调用 `MT5工具.py` 执行市价单或挂单
    * 监控持仓状态，检测单子是否平仓
    * **保本逻辑**: 当同组信号中有单子止盈后，自动将剩余单子的止损移至开仓价
* **启动**: `python 执行端.py`

### 4. 📊 统计端 (`统计端.py`)
* **职责**: 系统的"记账员"。实时监控持仓变化，归档战绩，计算 KOL 胜率。
* **核心功能**:
    * 极速持仓监控（每5秒）：从 MT5 拉取持仓，检测减仓/平仓
    * 历史审计与自动保本（每180秒或被触发）：拉取历史订单，补录数据，计算战役盈亏
    * 自动RR止盈监控：根据风险回报比(RR)自动触发分批止盈
* **数据流**: 将完成的交易写入 `settlements` 表，供仪表盘展示
* **启动**: `python 统计端.py` (默认监听 7777 端口)

### 5. 🖥️ 监控台 (`仪表盘.py`)
* **职责**: 系统的"脸面"。Streamlit Web 界面，展示实时持仓、KOL 排行榜、历史信号。
* **启动**: `streamlit run 仪表盘.py`

---

## 📋 数据库结构 (Database Schema)

SQLite 数据库 `影子订单簿.db` 包含 5 张核心表：

| 表名 | 用途 | 关键字段 |
|------|------|--------|
| **shadow_signals** | 父信号表，记录原始 KOL 信号 | `signal_id`, `kol_name`, `symbol`, `entry_price`, `stop_loss` |
| **command_queue** | 子命令队列，存储待执行的具体下单指令 | `command_id`, `signal_id`, `status`, `order_type` |
| **active_positions** | 当前持仓表，记录所有活跃的 MT5 订单 | `ticket`, `symbol`, `volume`, `open_price`, `stop_loss` |
| **settlements** | 结算表，归档已平仓的交易记录 | `settlement_id`, `signal_id`, `profit_loss`, `close_price` |
| **execution_logs** | 执行日志流水账 | `log_id`, `timestamp`, `action`, `details` |

**关键关联**: `signal_id` 字段将父信号、子命令、持仓记录关联起来，用于实现同组保本逻辑。

---

## ⚙️ 配置文件详解 (Configuration)

### `配置.json` (业务配置)

```json
{
  "系统全局开关": {
    "只允许白名单信号": true,
    "监听群组ID": -1003532872739
  },

  "品种映射表": {
    "XAUUSD": "XAUUSD+",
    "GOLD": "XAUUSD+",
    "EURUSD": "EURUSD+",
    "GBPUSD": "GBPUSD+"
  },

  "资金管理": {
    "当前模式": "以损定仓",
    "以损定仓配置": {
      "默认风险率": 0.06,
      "特殊品种风险率": {
        "XAU": 0.09,
        "GOLD": 0.05
      },
      "单笔最大手数限制": 5.0,
      "单笔最小手数限制": 0.01
    }
  },

  "KOL监听名单": {
    "2": "黄金帝国",
    "4": "外汇 - Ken",
    "10": "外汇 - Nightvex 夜魔"
  }
}
```

**关键参数说明**:
- **风险率**: 账户余额的百分比，用于计算允许亏损金额
- **品种映射**: AI 识别的标准名称 → MT5 实际使用的后缀名称
- **KOL 名单**: 话题ID → KOL 名称，用于过滤白名单信号

### `key.json` (敏感凭证，已加入 .gitignore)

```json
{
  "telegram": {
    "api_id": "YOUR_API_ID",
    "api_hash": "YOUR_API_HASH",
    "session_name": "monitor_scout_final"
  },

  "mt5": {
    "terminal_path": "C:\\Program Files\\MetaTrader 5\\terminal64.exe",
    "account_id": 123456789,
    "password": "YOUR_PASSWORD",
    "server": "ICMarkets-Demo"
  },

  "ai_decision": {
    "api_url": "https://api.openai.com/v1/chat/completions",
    "api_key": "YOUR_API_KEY",
    "model": "gpt-4-vision"
  }
}
```

---

## 🚀 快速启动指南 (Quick Start)

### 前置条件

1. **Python 环境**: Python 3.8+
2. **依赖库**:
   ```bash
   pip install MetaTrader5 telethon flask requests streamlit pandas plotly
   ```
3. **MT5 终端**: 已安装并登录
4. **Telegram 账号**: 已加入监听群组
5. **配置文件**: 已准备好 `key.json` 和 `配置.json`

### 标准启动顺序

**⚠️ 重要**: 必须按照以下顺序启动，每个进程独立运行（建议用不同的终端窗口）：

#### 第 1 步：启动决策端（必须先启动）
```bash
python 决策端.py
```
- 启动 Flask HTTP 服务器，监听 5010 端口
- 等待监听端连接
- 输出示例: `[HH:MM:SS] 🚀 决策端已启动，监听 http://localhost:5010`

#### 第 2 步：启动执行端
```bash
python 执行端.py
```
- 连接 MT5 终端
- 轮询数据库，执行待执行命令
- 输出示例: `[HH:MM:SS] ✅ 执行端已启动，开始监控命令队列`

#### 第 3 步：启动监听端
```bash
python 监听TG.py
```
- 连接 Telegram
- 开始监听群组消息
- 将信号发送到决策端的 `/webhook` 接口
- 输出示例: `[HH:MM:SS] 👂 监听端已启动，开始监听 Telegram 群组`

#### 第 4 步（可选）：启动统计端
```bash
python 统计端.py
```
- 实时监控持仓变化
- 自动触发保本逻辑
- 计算战绩统计
- 输出示例: `[HH:MM:SS] ⚡ 实时监控线程已启动`

#### 第 5 步（可选）：启动仪表盘
```bash
streamlit run 仪表盘.py
```
- 启动 Web 界面（默认 http://localhost:8501）
- 展示实时持仓、KOL 排行榜、历史信号

---

## 🔧 关键算法详解

### 以损定仓计算 (Position Sizing)

```
允许亏损金额 = 账户余额 × 风险率
止损距离 = |入场价 - 止损价|
计算手数 = 允许亏损金额 / (止损距离 × 合约大小)
最终手数 = min(max(计算手数, 最小手数), 最大手数)
```

**示例**:
- 账户余额: $10,000
- 风险率: 6%
- 允许亏损: $600
- 入场价: 2050, 止损: 2040
- 止损距离: 10
- 黄金合约大小: 100
- 计算手数: 600 / (10 × 100) = 0.6 手

### 保本触发逻辑 (Break-Even Logic)

当检测到某个 Ticket 平仓且盈利 > 0 时：
1. 查询同 `signal_id` 的所有剩余持仓
2. 调用 MT5 API 将它们的止损修改为开仓价
3. 记录保本事件到数据库

### 品种映射修正 (Symbol Mapping)

AI 可能识别出 `XAUUSD` 或 `XAUUSDm`，系统会查找 `配置.json` 中的映射表，转换为 MT5 实际使用的 `XAUUSD+`。

---

## 🚨 风险与配置警告 (Critical Warnings) - **必读**

**在使用本系统实盘资金之前，请务必阅读以下内容。此处包含极高风险的个人化设置！**

### 1. ⚠️ 硬编码风险警告

本系统的代码逻辑基于开发者个人账户情况进行了定制化配置。很多参数是"硬编码"的，**使用前必须仔细检查所有配置文件**，避免因参数不匹配导致爆仓。

**典型排雷案例**:
- 资金放大系数
- 风险率设置
- 品种映射表
- 单笔手数限制

### 2. MT5 连接要求

- 执行端和决策端都需要连接 MT5（决策端用于查询余额和合约规格）
- MT5 必须保持运行状态
- 确保 `key.json` 中的终端路径正确

### 3. 数据库自动修复

`数据库工具.py` 的 `初始化数据库()` 函数包含自动补丁逻辑，会检测并修复旧版本缺失的字段（如 `error_msg`, `signal_id`, `tp_goal`）。

### 4. 失败处理策略

执行端遇到下单失败时，会调用 `标记_命令失败()` 将状态改为 "失败"，**不会重试**，防止无限循环。

### 5. 建议小资金测试

初次使用推荐用**小号**或**极小资金**跑通流程，验证所有配置无误后再用实盘资金。

---

## 🛡️ 安全协议 (Security Protocol)

**严禁将 `key.json` 上传至 GitHub 或任何公开网络！**

为了保护您的资金安全，本项目采用了严格的凭证隔离策略：

1. **配置文件**：所有的 API Key、Secret 以及私有风控参数都存储在 `key.json` 文件中。
2. **Git 忽略**：该文件已被加入 `.gitignore`，**请勿强制提交**。
3. **分发方式**：
   * 由于每位用户的仓位参数和交易所 Key 都不同，该文件不包含在代码库中。
   * 请使用私下分发的模板，或根据 `key.json` 格式在本地创建。
   * 创建 API Key 时只勾选交易权限，**不要勾选提现功能！**
   * **一旦泄露，请立即前往 MT5 删除并重置 API Key。**

---

## 📡 信号源与环境配置 (Signal Source & Setup)

### 1. 监听目标

请确保你的账号已加入以下用于监听的 Telegram 频道/群组：
> **[https://t.me/+gVBApT2Lb_0xZDM9](https://t.me/+gVBApT2Lb_0xZDM9)**

### 2. 获取 Telegram API

运行本项目需要你申请 Telegram 的 `API ID` 和 `API Hash`。

* **申请教程**：直接询问 AI（如 ChatGPT/Gemini）："如何申请 Telegram API？"
* **⚠️ 避坑指南**：Telegram 官方申请页面经常会在最后一步报错卡住。
  * **解决方案**：不要浪费时间纠结，**直接去闲鱼花 10 块钱找人解决即可**，省时省力。

### 3. 环境配置

将所有代码文件下载到本地后，请确保 `key.json` 位于根目录，并填入正确的参数。

---

## 🤖 AI 辅助运行指南 (AI Pair Programming)

为了降低上手门槛，建议把本项目当作一个单纯的代码库，具体操作完全依赖 AI 指导。

### 最佳投喂步骤 (Step-by-Step)

1. **准备文件**：找到所有的 `.py` 脚本和其他相关文件。

2. **静默上传 (关键技巧)**：
   * 分批将文件上传给 AI 助手（如 Claude、Gemini、ChatGPT）。
   * **让 AI 闭嘴**：在上传过程中，务必告诉 AI **"只读取文件，不要分析，不要回复，直到我说'发送完毕'。"**
   * *理由*：防止 AI 在只看到一部分代码时就开始胡乱分析，导致上下文混乱。

3. **正式提问**：
   * 当所有文件传完后，输入指令：
   ```
   文件发送完毕。请阅读以上所有代码，根据我的 key.json 配置，教我如何启动这个系统。

   具体要求：
   1. 说明各个文件的作用
   2. 列出启动顺序
   3. 检查配置是否有问题
   4. 告诉我如何调试常见问题
   ```

### 模型推荐 (Tips)

推荐使用 **Claude 3.5 Sonnet** 或 **Gemini 2.0 Flash**。
* **理由**：逻辑推理能力强，适合处理复杂的交易信号判断和系统架构理解。
* **成本提示**：目前第三方渠道成本极低，性价比极高。

---

## 🐛 调试技巧 (Debugging Tips)

### 查看实时日志

所有模块使用 `数据库工具.带时间的日志打印()` 输出带时间戳的日志，格式为 `[HH:MM:SS] 消息内容`。

### 测试 AI 决策

```bash
python AI分析.py
```
会运行内置的单元测试，模拟解析一个复杂的挂单信号。

### 测试数据库工具

```bash
python 数据库工具.py
```
会创建测试信号并验证父子关联逻辑。

### 测试 MT5 连接

```bash
python MT5工具.py
```
会测试行情获取、账户查询、合约规格查询功能。

### 查看数据库内容

```bash
python 查看数据库.py
```
会打印数据库中的所有表和记录。

---

## 📁 项目文件结构 (File Structure)

```
kol_gold/
├── 监听TG.py              # 监听端：Telegram 消息监听
├── 决策端.py              # 决策端：AI 分析 + 仓位计算
├── 执行端.py              # 执行端：MT5 下单执行
├── 统计端.py              # 统计端：持仓监控 + 战绩统计
├── 仪表盘.py              # 监控台：Streamlit Web 界面
├── AI分析.py              # AI 决策大脑
├── MT5工具.py             # MT5 API 封装
├── 数据库工具.py          # SQLite 数据库操作
├── 交易日志美化打印.py    # 日志格式化输出
├── 配置.json              # 业务配置（品种映射、风险率等）
├── key.json               # 敏感凭证（Telegram、MT5、AI API）
├── 提示词.txt             # AI 大脑的 System Prompt
├── 影子订单簿.db          # SQLite 数据库
└── README.md              # 本文件
```

---

## ⚖️ 免责声明 (Disclaimer)

* **风险提示**：外汇交易具有极高的风险，可能导致资金全额损失。
* **仅供参考**：本软件仅作为自动化执行工具，不构成任何投资建议。
* **责任自负**：使用者需自行承担因软件故障、网络延迟、MT5 API 变动、KOL 信号错误或代码中隐含逻辑差异导致的任何资产损失。

---

## 📞 获取帮助 (Support)

* **问题排查**：查看本 README 的"调试技巧"部分
* **代码理解**：使用 AI 辅助（推荐 Claude Code）
* **Bug 报告**：提交 GitHub Issue（不要包含敏感信息）

---

*Last Updated: 2026-01-21*
